<h1>Incidencias</h1>

<form id="search-form">
    <input type="text" name="search" id="search" placeholder="Buscar incidencia..." value="<%= search %>">
    <button type="submit">Buscar</button>
</form>

<table class="table">
    <thead>
        <tr>
            <th>Dispositivo</th>
            <th>Tipo</th>
            <th>Fecha</th>
            <th>Descripción</th>
            <th>Usuario</th>
            <th>Resuelto</th>
            <th>Trabajador</th>
            <th>Conforme</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        <% incidencias.forEach(incidencia=> { %>
            <tr>
                <td>
                    <%= incidencia.dispositivo.nombre %>
                </td>
                <td>
                    <%= incidencia.tipo_incidencia %>
                </td>
                <td>
                    <%= incidencia.fecha_incidencia %>
                </td>
                <td>
                    <%= incidencia.descripcion %>
                </td>
                <td>
                    <%= incidencia.usuario.nombre %>
                </td>
                <td>
                    <%= incidencia.resuelto %>
                </td>
                <td>
                    <%= incidencia.trabajador ? incidencia.trabajador.nombre : 'N/A' %>
                </td>
                <td>
                    <%= incidencia.conforme %>
                </td>
                <td>
                    <a href="#" class="btn btn-danger btn-sm"
                        onclick="eliminarIncidencia(<%= incidencia.id %>)">Eliminar</a>
                </td>
            </tr>
            <% }); %>
    </tbody>
</table>

<nav aria-label="Page navigation">
    <ul class="pagination">
        <% for (let i=1; i <=Math.ceil(count / limit); i++) { %>
            <li class="page-item <%= i == page ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= i %>&search=<%= search %>">
                    <%= i %>
                </a>
            </li>
            <% } %>
    </ul>
</nav>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $('#search-form').submit(function (event) {
        event.preventDefault();
        const search = $('#search').val();
        window.location.href = `?search=${search}`;
    });
    function eliminarIncidencia(id) {
        if (confirm('¿Estás seguro de eliminar esta incidencia?')) {
            fetch(`/dashboard/device/incidencia/${id}/delete`, { method: 'DELETE' })
                .then(() => location.reload());
        }
    }
</script>